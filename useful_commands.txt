##################
#  model server  #
##################

# Build docker and helm package
docker build .\model-server -t model-server:0.1 --no-cache
helm package .\charts\model-server\ -d .\charts\model-server\

# Helm install
helm install model-server .\charts\model-server\model-server-1.0.0.tgz

# Port forward access
kubectl port-forward svc/model-server-service 5000:80

################
#  sso server  #
################

# Build image for post install hook
docker build .\sso-server\realm-setup -t sso-server-post-install:0.1 --no-cache

# Build docker and helm package
docker build .\sso-server -t sso-server:0.1 --no-cache
helm package .\charts\sso-server\ -d .\charts\sso-server\

# Helm install
helm install sso-server .\charts\sso-server\sso-server-1.0.0.tgz --timeout 60s

# Port forward access
kubectl port-forward svc/sso-server-service 443:443

# Install ingress controller
# https://apisix.apache.org/docs/ingress-controller/deployments/minikube/#install-apisix-and-apisix-ingress-controller
# https://apisix.apache.org/docs/ingress-controller/practices/proxy-the-httpbin-service
# https://apisix.apache.org/docs/apisix/plugins/openid-connect/

helm install apisix apisix/apisix --set gateway.type=NodePort --set gateway.tls.enabled=true --set ingress-controller.enabled=true --namespace default --set ingress-controller.config.apisix.serviceNamespace=default

# Generate self signed cert
# https://wiki.openssl.org/index.php/Binaries
openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout privateKey.key -out certificate.crt